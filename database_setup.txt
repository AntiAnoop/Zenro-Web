
-- ----------------------------------------------------------------
-- ZENRO DATABASE SETUP SCRIPT (ARCHITECTURAL UPDATE)
-- ----------------------------------------------------------------

-- 1. CLEANUP
DROP TABLE IF EXISTS assignment_submissions CASCADE;
DROP TABLE IF EXISTS assignment_enrollments CASCADE;
DROP TABLE IF EXISTS assignment_batches CASCADE;
DROP TABLE IF EXISTS assignments CASCADE;

DROP TABLE IF EXISTS attendance CASCADE;
DROP TABLE IF EXISTS live_sessions CASCADE;
DROP TABLE IF EXISTS schedules CASCADE;
DROP TABLE IF EXISTS test_enrollments CASCADE;
DROP TABLE IF EXISTS test_batches CASCADE;

DROP TABLE IF EXISTS payments CASCADE;
DROP TABLE IF EXISTS fees CASCADE;
DROP TABLE IF EXISTS submissions CASCADE;
DROP TABLE IF EXISTS questions CASCADE;
DROP TABLE IF EXISTS tests CASCADE;
DROP TABLE IF EXISTS course_enrollments CASCADE;
DROP TABLE IF EXISTS course_batches CASCADE;
DROP TABLE IF EXISTS course_materials CASCADE;
DROP TABLE IF EXISTS course_modules CASCADE;
DROP TABLE IF EXISTS courses CASCADE;
DROP TABLE IF EXISTS teacher_batches CASCADE; -- NEW
DROP TABLE IF EXISTS batches CASCADE;
DROP TABLE IF EXISTS profiles CASCADE;

-- 2. CREATE TABLES

CREATE TABLE profiles (
  id text PRIMARY KEY DEFAULT gen_random_uuid()::text,
  email text UNIQUE NOT NULL,
  password text NOT NULL,
  full_name text NOT NULL,
  role text CHECK (role IN ('STUDENT', 'TEACHER', 'ADMIN')),
  batch text, -- Only for STUDENTS (Single batch)
  phone text,
  student_id text,
  avatar_url text,
  created_at timestamptz DEFAULT now()
);

CREATE TABLE batches (
  id text PRIMARY KEY DEFAULT gen_random_uuid()::text,
  name text UNIQUE NOT NULL,
  created_at timestamptz DEFAULT now()
);

-- NEW: Link Teachers to Multiple Batches
CREATE TABLE teacher_batches (
  id text PRIMARY KEY DEFAULT gen_random_uuid()::text,
  teacher_id text REFERENCES profiles(id) ON DELETE CASCADE,
  batch_name text NOT NULL
);

CREATE TABLE courses (
  id text PRIMARY KEY DEFAULT gen_random_uuid()::text,
  title text NOT NULL,
  description text,
  level text CHECK (level IN ('N5', 'N4', 'N3', 'N2', 'N1')),
  thumbnail text,
  status text DEFAULT 'DRAFT',
  instructor_name text,
  created_at timestamptz DEFAULT now()
);

CREATE TABLE course_modules (
  id text PRIMARY KEY DEFAULT gen_random_uuid()::text,
  course_id text REFERENCES courses(id) ON DELETE CASCADE,
  title text NOT NULL,
  "order" int DEFAULT 0,
  created_at timestamptz DEFAULT now()
);

CREATE TABLE course_materials (
  id text PRIMARY KEY DEFAULT gen_random_uuid()::text,
  module_id text REFERENCES course_modules(id) ON DELETE CASCADE,
  title text NOT NULL,
  type text CHECK (type IN ('PDF', 'DOC', 'LINK', 'VIDEO')),
  url text NOT NULL,
  created_at timestamptz DEFAULT now()
);

CREATE TABLE course_batches (
  id text PRIMARY KEY DEFAULT gen_random_uuid()::text,
  course_id text REFERENCES courses(id) ON DELETE CASCADE,
  batch_name text NOT NULL,
  created_at timestamptz DEFAULT now()
);

CREATE TABLE course_enrollments (
  id text PRIMARY KEY DEFAULT gen_random_uuid()::text,
  course_id text REFERENCES courses(id) ON DELETE CASCADE,
  student_id text REFERENCES profiles(id) ON DELETE CASCADE,
  created_at timestamptz DEFAULT now()
);

-- TESTS SYSTEM
CREATE TABLE tests (
  id text PRIMARY KEY DEFAULT gen_random_uuid()::text,
  title text NOT NULL,
  description text, 
  duration_minutes int DEFAULT 30,
  passing_score int DEFAULT 40,
  is_active boolean DEFAULT false, 
  allow_multiple_attempts boolean DEFAULT false, 
  created_at timestamptz DEFAULT now()
);

CREATE TABLE questions (
  id text PRIMARY KEY DEFAULT gen_random_uuid()::text,
  test_id text REFERENCES tests(id) ON DELETE CASCADE,
  question_text text NOT NULL,
  options text[] NOT NULL,
  correct_option_index int NOT NULL,
  marks int DEFAULT 1,
  created_at timestamptz DEFAULT now()
);

CREATE TABLE test_batches (
  id text PRIMARY KEY DEFAULT gen_random_uuid()::text,
  test_id text REFERENCES tests(id) ON DELETE CASCADE,
  batch_name text NOT NULL,
  created_at timestamptz DEFAULT now()
);

CREATE TABLE test_enrollments (
  id text PRIMARY KEY DEFAULT gen_random_uuid()::text,
  test_id text REFERENCES tests(id) ON DELETE CASCADE,
  student_id text REFERENCES profiles(id) ON DELETE CASCADE,
  created_at timestamptz DEFAULT now()
);

CREATE TABLE submissions (
  id text PRIMARY KEY DEFAULT gen_random_uuid()::text,
  test_id text REFERENCES tests(id) ON DELETE CASCADE,
  student_id text REFERENCES profiles(id) ON DELETE CASCADE,
  score int NOT NULL,
  total_score int NOT NULL,
  answers jsonb,
  status text CHECK (status IN ('IN_PROGRESS', 'COMPLETED', 'TERMINATED')),
  feedback text,
  completed_at timestamptz DEFAULT now()
);

-- ASSIGNMENTS SYSTEM
CREATE TABLE assignments (
  id text PRIMARY KEY DEFAULT gen_random_uuid()::text,
  title text NOT NULL,
  description text,
  due_date timestamptz NOT NULL,
  total_marks int DEFAULT 100,
  attachment_url text,
  status text DEFAULT 'DRAFT', 
  created_at timestamptz DEFAULT now()
);

CREATE TABLE assignment_batches (
  id text PRIMARY KEY DEFAULT gen_random_uuid()::text,
  assignment_id text REFERENCES assignments(id) ON DELETE CASCADE,
  batch_name text NOT NULL
);

CREATE TABLE assignment_enrollments (
  id text PRIMARY KEY DEFAULT gen_random_uuid()::text,
  assignment_id text REFERENCES assignments(id) ON DELETE CASCADE,
  student_id text REFERENCES profiles(id) ON DELETE CASCADE
);

CREATE TABLE assignment_submissions (
  id text PRIMARY KEY DEFAULT gen_random_uuid()::text,
  assignment_id text REFERENCES assignments(id) ON DELETE CASCADE,
  student_id text REFERENCES profiles(id) ON DELETE CASCADE,
  submission_url text,
  submission_text text,
  obtained_marks int DEFAULT 0,
  feedback text,
  status text DEFAULT 'SUBMITTED', 
  submitted_at timestamptz DEFAULT now()
);

CREATE TABLE fees (
  id text PRIMARY KEY DEFAULT gen_random_uuid()::text,
  student_id text REFERENCES profiles(id) ON DELETE CASCADE,
  title text NOT NULL,
  amount numeric NOT NULL,
  due_date date,
  status text DEFAULT 'PENDING' CHECK (status IN ('PENDING', 'PAID', 'OVERDUE')),
  category text,
  phase int DEFAULT 1,
  created_at timestamptz DEFAULT now()
);

CREATE TABLE payments (
  id text PRIMARY KEY DEFAULT gen_random_uuid()::text,
  fee_id text REFERENCES fees(id) ON DELETE CASCADE,
  razorpay_payment_id text,
  amount numeric,
  payment_date timestamptz DEFAULT now()
);

-- SCHEDULING & ATTENDANCE

CREATE TABLE schedules (
  id text PRIMARY KEY DEFAULT gen_random_uuid()::text,
  teacher_id text REFERENCES profiles(id),
  batch_name text NOT NULL,
  title text NOT NULL,
  start_time timestamptz NOT NULL,
  end_time timestamptz NOT NULL,
  created_at timestamptz DEFAULT now()
);

CREATE TABLE live_sessions (
  id text PRIMARY KEY DEFAULT gen_random_uuid()::text,
  teacher_id text REFERENCES profiles(id),
  batch_name text,
  topic text,
  start_time timestamptz DEFAULT now(),
  end_time timestamptz,
  status text DEFAULT 'LIVE', 
  created_at timestamptz DEFAULT now()
);

CREATE TABLE attendance (
  id text PRIMARY KEY DEFAULT gen_random_uuid()::text,
  session_id text REFERENCES live_sessions(id),
  student_id text REFERENCES profiles(id),
  join_time timestamptz DEFAULT now(),
  last_heartbeat timestamptz DEFAULT now(),
  total_minutes int DEFAULT 0,
  status text DEFAULT 'PRESENT'
);

-- ----------------------------------------------------------------
-- 3. ENABLE ROW LEVEL SECURITY & POLICIES
-- ----------------------------------------------------------------

ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE batches ENABLE ROW LEVEL SECURITY;
ALTER TABLE teacher_batches ENABLE ROW LEVEL SECURITY;
ALTER TABLE courses ENABLE ROW LEVEL SECURITY;
ALTER TABLE course_modules ENABLE ROW LEVEL SECURITY;
ALTER TABLE course_materials ENABLE ROW LEVEL SECURITY;
ALTER TABLE course_batches ENABLE ROW LEVEL SECURITY;
ALTER TABLE course_enrollments ENABLE ROW LEVEL SECURITY;
ALTER TABLE tests ENABLE ROW LEVEL SECURITY;
ALTER TABLE questions ENABLE ROW LEVEL SECURITY;
ALTER TABLE test_batches ENABLE ROW LEVEL SECURITY;
ALTER TABLE test_enrollments ENABLE ROW LEVEL SECURITY;
ALTER TABLE submissions ENABLE ROW LEVEL SECURITY;
ALTER TABLE assignments ENABLE ROW LEVEL SECURITY;
ALTER TABLE assignment_batches ENABLE ROW LEVEL SECURITY;
ALTER TABLE assignment_enrollments ENABLE ROW LEVEL SECURITY;
ALTER TABLE assignment_submissions ENABLE ROW LEVEL SECURITY;
ALTER TABLE fees ENABLE ROW LEVEL SECURITY;
ALTER TABLE payments ENABLE ROW LEVEL SECURITY;
ALTER TABLE schedules ENABLE ROW LEVEL SECURITY;
ALTER TABLE live_sessions ENABLE ROW LEVEL SECURITY;
ALTER TABLE attendance ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Enable all access for all users" ON profiles FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Enable all access for all users" ON batches FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Enable all access for all users" ON teacher_batches FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Enable all access for all users" ON courses FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Enable all access for all users" ON course_modules FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Enable all access for all users" ON course_materials FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Enable all access for all users" ON course_batches FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Enable all access for all users" ON course_enrollments FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Enable all access for all users" ON tests FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Enable all access for all users" ON questions FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Enable all access for all users" ON test_batches FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Enable all access for all users" ON test_enrollments FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Enable all access for all users" ON submissions FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Enable all access for all users" ON assignments FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Enable all access for all users" ON assignment_batches FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Enable all access for all users" ON assignment_enrollments FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Enable all access for all users" ON assignment_submissions FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Enable all access for all users" ON fees FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Enable all access for all users" ON payments FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Enable all access for all users" ON schedules FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Enable all access for all users" ON live_sessions FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Enable all access for all users" ON attendance FOR ALL USING (true) WITH CHECK (true);

-- 4. SEED DATA

INSERT INTO batches (name) VALUES ('2024-A'), ('2024-B');

INSERT INTO profiles (id, email, password, full_name, role, batch, phone, student_id) 
VALUES 
('s1', 'student@zenro.jp', '9999999999', 'Alex Student', 'STUDENT', '2024-A', '9999999999', '9999999999'),
('t1', 'teacher@zenro.jp', '8888888888', 'Tanaka Sensei', 'TEACHER', NULL, '8888888888', '8888888888'),
('a1', 'admin@zenro.jp', '7777777777', 'Admin User', 'ADMIN', NULL, '7777777777', '7777777777');

INSERT INTO teacher_batches (teacher_id, batch_name) VALUES ('t1', '2024-A'), ('t1', '2024-B');

INSERT INTO courses (id, title, description, level, thumbnail, status, instructor_name) 
VALUES ('c1', 'JLPT N4 Grammar Mastery', 'Comprehensive guide to N4 grammar structures.', 'N4', 'https://images.unsplash.com/photo-1528164344705-47542687000d', 'PUBLISHED', 'Tanaka Sensei');

INSERT INTO course_batches (course_id, batch_name) VALUES ('c1', '2024-A');

INSERT INTO tests (id, title, description, duration_minutes, passing_score, is_active, allow_multiple_attempts)
VALUES ('test1', 'N4 Weekly Mock Exam', 'A practice test for the upcoming JLPT.', 45, 50, true, false);

INSERT INTO test_batches (test_id, batch_name) VALUES ('test1', '2024-A');

INSERT INTO questions (test_id, question_text, options, correct_option_index, marks)
VALUES 
('test1', 'Meaning of "Taberu" (食べる)?', ARRAY['To Drink', 'To Eat', 'To Sleep', 'To Run'], 1, 2),
('test1', 'Select the correct particle: Watashi __ Tanaka desu.', ARRAY['wa', 'ga', 'wo', 'ni'], 0, 1);

INSERT INTO assignments (id, title, description, due_date, total_marks, status)
VALUES ('hw1', 'Kanji Writing Practice Ch.1', 'Write each Kanji 10 times and submit a photo.', now() + interval '7 days', 20, 'PUBLISHED');

INSERT INTO assignment_batches (assignment_id, batch_name) VALUES ('hw1', '2024-A');
